# Evaluador de Reglas Transversales de DevSecOps\n\n

## PASO 1. Reinicio de Memoria de Contexto\n- Pregunta al usuario si esta es una sesi√≥n nueva.\n  - Si la respuesta es s√≠, contin√∫a con los siguientes pasos.\n  - Si la respuesta es no, indica que debe abrir una nueva ventana y volver a ejecutar el prompt.\n\n

## PASO 2. Obtenci√≥n de Reglas\n- Usa la herramienta getPragmaResources para obtener el recurso 'devsecops-all-rules.md' desde el servidor MCP Pragma.\n- Si la obtenci√≥n es exitosa, utiliza el contenido como base para la evaluaci√≥n.\n- Si la obtenci√≥n falla, notifica al usuario y det√©n el proceso.\n\n

## PASO 3. Evaluaci√≥n del Repositorio\n\n**IMPORTANTE: SIGUE LAS INSTRUCCIONES DE LA REGLA 1 DEL RECURSO 'devsecops-all-rules.md' y ten presente el resultado para seleccionar las reglas siguientes adecuados y que le apliquen a este repositorio.**\n\n

## PASO 4. Este paso debe ejecutarse despues del resultado del Paso 3 üõë VALIDACI√ìN OBLIGATORIA DE REPORTES EXTERNOS QUE APLIQUEN (NO OMITIR)\n\n**‚ö†Ô∏è CR√çTICO: Este paso es OBLIGATORIO y NO debe ser omitido. **\n\n

### 4.1 Validaci√≥n de Reporte DAST SI APLICA segun resultado de Paso 3 (An√°lisis Din√°mico)\n\n**DETENER LA EJECUCI√ìN Y PREGUNTAR AL USUARIO:**\n\n```\nüî¥ PREGUNTA OBLIGATORIA - Reporte DAST:\n\n¬øDispone de un reporte de an√°lisis din√°mico (DAST) generado previamente?\n\nHerramientas comunes: OWASP ZAP, Burp Suite, Acunetix, Nessus, etc.\n\nOpciones:\n  a) S√ç - Tengo un reporte DAST externo\n  b) NO - Continuar con validaci√≥n por conocimiento del c√≥digo\n  c) NO - Saltar esta validaci√≥n (no recomendado)\n\nPor favor, indique su respuesta (a/b/c):\n```\n\n**Si la respuesta es (a) S√ç:**\n- Solicitar al usuario la ubicaci√≥n exacta del archivo\n  - Ejemplo: `/reports/owasp_zap_report_2025-11-20.html`\n  - Ejemplo: `/reports/burp_suite_scan_2025-11-20.xml`\n- Solicitar el formato del reporte (HTML, JSON, XML, PDF)\n- Leer el archivo usando las herramientas disponibles\n- Analizar el contenido del reporte y extraer hallazgos\n- **Si la respuesta es (b) NO - Continuar con validaci√≥n:**\n- Confirmar con el usuario: \"Proceder√© con validaci√≥n DAST basada en conocimiento del c√≥digo y mejores pr√°cticas. ¬øEst√° de acuerdo? (s√≠/no)\"\n- Esperar confirmaci√≥n antes de continuar\n\n**Si la respuesta es (c) NO - Saltar validaci√≥n:**\n- Advertir al usuario: \"‚ö†Ô∏è Saltar la validaci√≥n DAST puede dejar vulnerabilidades sin detectar. ¬øConfirma que desea omitir? (s√≠/no)\"\n- Si confirma, marcar la Regla 5 (DAST) como \"No evaluada por decisi√≥n del usuario\"\n\n

### 4.2 Validaci√≥n de Reporte SCA SI APLICA segun resultado de Paso 3 (Composici√≥n de Software)\n\n**VERIFICAR DISPONIBILIDAD DE TRIVY MCP:**\n- Intentar ejecutar el escaneo con Trivy usando la herramienta disponible\n- Si Trivy est√° disponible y funciona correctamente: Continuar al Paso 5\n- Si Trivy NO est√° disponible o falla: Continuar con las preguntas siguientes\n\n**SI TRIVY NO EST√Å DISPONIBLE, DETENER Y PREGUNTAR AL USUARIO:**\n\n```\nüî¥ PREGUNTA OBLIGATORIA - Reporte SCA:\n\nTrivy MCP no est√° disponible o no pudo ejecutarse.\n\n¬øDispone de un reporte de an√°lisis de composici√≥n de software (SCA) generado previamente?\n\nHerramientas comunes: Trivy, Snyk, OWASP Dependency Check, WhiteSource, etc.\n\nOpciones:\n  a) S√ç - Tengo un reporte SCA externo\n  b) NO - Continuar con validaci√≥n por conocimiento de dependencias\n  c) NO - Saltar esta validaci√≥n (no recomendado)\n\nPor favor, indique su respuesta (a/b/c):\n```\n\n**Si la respuesta es (a) S√ç:**\n- Solicitar al usuario la ubicaci√≥n exacta del archivo\n  - Ejemplo: `/reports/trivy_scan_2025-11-20.json`\n  - Ejemplo: `/reports/dependency_check_report.html`\n- Solicitar el formato del reporte (JSON, HTML, XML, CSV)\n- Leer el archivo usando las herramientas disponibles\n- Analizar el contenido del reporte y extraer vulnerabilidades\n- **Si la respuesta es (b) NO - Continuar con validaci√≥n:**\n- Confirmar con el usuario: \"Proceder√© con validaci√≥n SCA basada en an√°lisis de archivos de dependencias (build.gradle, package.json, etc.). ¬øEst√° de acuerdo? (s√≠/no)\"\n- Esperar confirmaci√≥n antes de continuar\n\n**Si la respuesta es (c) NO - Saltar validaci√≥n:**\n- Advertir al usuario: \"‚ö†Ô∏è Saltar la validaci√≥n SCA puede dejar vulnerabilidades en dependencias sin detectar. ¬øConfirma que desea omitir? (s√≠/no)\"\n- Si confirma, marcar la Regla 6 (SCA) como \"No evaluada por decisi√≥n del usuario\" en el reporte\n\n

### 4.3 Checkpoint de Confirmaci√≥n\n\n**ANTES de proceder al Paso 5, RESUMIR AL USUARIO:**\n\n```\nüìä Resumen de Fuentes para la Evaluaci√≥n DevSecOps:\n\n‚úÖ Reglas obtenidas: devsecops-all-rules.md (MCP Pragma)\n\nüîç An√°lisis Din√°mico (DAST):\n   - Fuente: [Reporte externo: ruta/archivo] o [Validaci√≥n por conocimiento] o [Omitido]\n\nüì¶ Composici√≥n de Software (SCA):\n   - Fuente: [Trivy MCP] o [Reporte externo: ruta/archivo] o [Validaci√≥n por conocimiento] o [Omitido]\n\n¬øDesea proceder con estas fuentes para generar el reporte DevSecOps? (s√≠/no)\n```\n\n**ESPERAR CONFIRMACI√ìN EXPL√çCITA DEL USUARIO ANTES DE CONTINUAR AL Paso 5**\n\n**Si el usuario responde NO:**\n- Preguntar: \"¬øQu√© desea modificar? (dast/sca/cancelar)\"\n- Regresar a la secci√≥n correspondiente (4.1 o 4.2)\n- Repetir el checkpoint de confirmaci√≥n\n\n**Si el usuario responde S√ç:**\n- Continuar al Paso 5\n\n

## PASO 5. - Analiza de nuevo el repositorio aplicando cada regla pendiente y recomendaci√≥n extra√≠da que aplique y haya sido aceptada por el usuario segun Paso 3 y 4  de 'devsecops-all-rules.md'.\n- Para cada criterio, verifica el cumplimiento en el c√≥digo y dependencias del repositorio.\n- Clasifica los hallazgos por nivel de criticidad (Cr√≠tico, Alto, Medio, Bajo).\n\n

## PASO 6. üîç üõë VALIDACI√ìN OBLIGATORIA REVISI√ìN DE HALLAZGOS CR√çTICOS (Validaci√≥n de Excepciones)\n\n**SI se detectaron hallazgos CR√çTICOS (üî¥) en el Paso 5:**\n\n

### 6.1 Presentar Hallazgos Cr√≠ticos al Usuario\n\n**DETENER LA EJECUCI√ìN Y MOSTRAR AL USUARIO:**\n\n```\n‚ö†Ô∏è HALLAZGOS CR√çTICOS DETECTADOS\n\nSe han identificado [N√öMERO] hallazgos de criticidad ALTA que requieren revisi√≥n:\n\n[Listar cada hallazgo cr√≠tico con formato:]\n  ID: HC-001\n  üìç Archivo: [ruta/archivo]\n  üìç L√≠nea: [n√∫mero o rango]\n  üîç Descripci√≥n: [descripci√≥n breve del hallazgo]\n  ‚ö†Ô∏è Riesgo: [explicaci√≥n del impacto en seguridad]\n\n  ID: HC-002\n  ...\n\n¬øAlguno de estos hallazgos cr√≠ticos tiene una justificaci√≥n v√°lida que deba documentarse?\n\nOpciones:\n  a) S√ç - Deseo justificar uno o m√°s hallazgos\n  b) NO - Todos los hallazgos son reales y deben remediarse\n  c) REVISAR - Necesito m√°s informaci√≥n sobre alg√∫n hallazgo\n\nPor favor, indique su respuesta (a/b/c):\n```\n\n

### 6.2 Proceso seg√∫n Respuesta del Usuario\n\n**Si la respuesta es (a) S√ç - Deseo justificar:**\n\n1. **Solicitar IDs a justificar:**\n   - \"Indique los IDs de los hallazgos que desea justificar (separados por coma):\"\n   - Ejemplo: \"HC-001, HC-003\"\n   - Validar que los IDs existan en la lista de hallazgos cr√≠ticos\n\n2. **Para cada ID indicado, preguntar categor√≠a de justificaci√≥n:**\n\n```\nüìù Justificaci√≥n para [ID - Descripci√≥n breve]\n\nSeleccione la categor√≠a de justificaci√≥n:\n\n  1) FALSO POSITIVO - El hallazgo es incorrecto o no aplica\n     Ejemplo: Variable llamada 'password' pero no contiene credenciales reales\n\n  2) RIESGO ACEPTADO - Se conoce el riesgo pero se acepta temporalmente\n     Ejemplo: Credencial de desarrollo en ambiente no productivo\n\n  3) MITIGACI√ìN EXISTENTE - Existe un control compensatorio\n     Ejemplo: Secreto expuesto pero con cifrado adicional en capa superior\n\n  4) EN PROCESO DE REMEDIACI√ìN - Ya se est√° trabajando en la soluci√≥n\n     Ejemplo: Ticket JIRA-1234 creado, fecha estimada de correcci√≥n\n\n  5) NO APLICA AL CONTEXTO - El hallazgo no es relevante para este proyecto\n     Ejemplo: Vulnerabilidad de framework web en proyecto de biblioteca\n\n  6) OTRA - Especificar justificaci√≥n personalizada\n\n Seleccione opci√≥n (1-6):\n```\n\n3. **Solicitar detalles adicionales:**\n\n```\nProporcione los detalles de la justificaci√≥n:\n\n- Explicaci√≥n: [Campo de texto libre]\n- Responsable de la decisi√≥n: [Nombre/Rol - opcional]\n- Fecha de revisi√≥n: [Fecha estimada para re-evaluaci√≥n - opcional]\n- Referencias: [Tickets, documentos, aprobaciones - opcional]\n```\n\n **Confirmar la justificaci√≥n:**\n   - Mostrar resumen de la justificaci√≥n capturada\n   - Preguntar: \"¬øEs correcta esta justificaci√≥n? (s√≠/no/editar)\"\n   - Si \"editar\", permitir modificar los campos\n   - Si \"no\", descartar y volver a preguntar\n   - Si \"s√≠\", marcar el hallazgo como \"Cr√≠tico Justificado\"\n\n **Resumen de justificaciones:**\n\n```\nüìã Resumen de Hallazgos Cr√≠ticos Justificados:\n\n- [ID]: [Categor√≠a] - [Explicaci√≥n breve]\n- [ID]: [Categor√≠a] - [Explicaci√≥n breve]\n\nEstos hallazgos se marcar√°n como \"üü° Cr√≠tico Justificado\" en el reporte.\n\n¬øDesea justificar alg√∫n hallazgo adicional? (s√≠/no)\n```\n\n**Si la respuesta es (b) NO - Todos son reales:**\n- Confirmar: \"Todos los hallazgos cr√≠ticos se documentar√°n como ‚ùå No Cumple sin justificaci√≥n\"\n- Continuar al Paso 7\n\n**Si la respuesta es (c) REVISAR - Necesito m√°s informaci√≥n:**\n- Preguntar: \"¬øSobre cu√°l hallazgo necesita m√°s informaci√≥n? (indique ID o 'todos')\"\n- Para cada hallazgo solicitado, mostrar:\n  * Contexto completo del c√≥digo donde se encontr√≥\n  * Extracto del archivo (5 l√≠neas antes y despu√©s)\n  * Regla DevSecOps espec√≠fica que se viol√≥\n  * Ejemplos de c√≥mo remediarlo\n- Despu√©s de mostrar la informaci√≥n, volver a preguntar opciones (a/b/c)\n\n

### 6.3 Actualizar Clasificaci√≥n de Hallazgos\n\n**Para cada hallazgo justificado:**\n- Cambiar el estado de \"üî¥ Cr√≠tico\" a \"üü° Cr√≠tico Justificado\"\n- Agregar la informaci√≥n de justificaci√≥n al registro del hallazgo\n- Mantener el hallazgo en el reporte pero con indicador visual diferente\n- NO contar el hallazgo justificado como \"No Cumple\" en el porcentaje de cumplimiento\n- S√ç contar el hallazgo justificado en una categor√≠a separada \"Excepciones Documentadas\"\n\n**SI NO se detectaron hallazgos cr√≠ticos:**\n- Saltar este paso y continuar directamente al Paso 7\n- Mencionar en el reporte: \"‚úÖ No se detectaron hallazgos cr√≠ticos en este an√°lisis\"\n\n

## PASO 7. Generaci√≥n de Reporte\n\n- Genera un reporte en formato Markdown en la carpeta 'reports', nombrado 'devsecops_all_rules_report_VERSIONADO.md' (usa SemVer: MAYOR.MENOR.PARCHE).\n- El reporte debe incluir:\n  - **Secci√≥n de Fuentes Utilizadas:** Especificar claramente qu√© reportes externos se analizaron y qu√© validaciones se realizaron por conocimiento\n  - Tabla visual con criterios evaluados y su estado (‚úîÔ∏è Cumple / ‚ùå No cumple / ‚ö†Ô∏è Parcial / N/A).\n  - Tabla de hallazgos clasificados por criticidad, con referencia a archivo y l√≠nea si aplica.\n  - **Secci√≥n de Hallazgos Cr√≠ticos Justificados (üü°):** Si existen hallazgos con justificaci√≥n aprobada del Paso 5, incluir secci√≥n dedicada\n  - **Para hallazgos de reportes externos:** Indicar la fuente del hallazgo (ej: \"Fuente: OWASP ZAP - reporte del 2025-11-20\")\n  - **Para hallazgos justificados:** Indicar categor√≠a, explicaci√≥n completa, responsable, fecha de revisi√≥n y referencias\n  - Barra de cumplimiento visual y porcentaje de cobertura (ejemplo: ‚ñà‚ñì‚ñí‚ñë 83%).\n  - **C√°lculo de cumplimiento:** Los hallazgos \"üü° Cr√≠tico Justificado\" NO cuentan como incumplimientos pero se documentan en secci√≥n separada\n  - Recomendaciones espec√≠ficas y priorizadas para cada hallazgo no cumplido.\n  - Resumen ejecutivo con los tres principales riesgos y pasos sugeridos para mejorar el cumplimiento.\n  - Fecha, versi√≥n del an√°lisis, LLM utilizado (nombre y versi√≥n), y hash corto del commit analizado.\n  - **Disclaimer de limitaciones:** Si alguna regla fue evaluada por conocimiento en lugar de reportes externos, indicarlo claramente\n\n

### Ejemplo de secci√≥n de fuentes:\n```markdown\n## üìä Fuentes Utilizadas en este An√°lisis\n\n| Regla | Tipo | Fuente | M√©todo |\n|-------|------|--------|--------|\n| 1. An√°lisis Autom√°tico | Auto | Estructura del proyecto | An√°lisis de archivos |\n| 2. Almacenamiento Seguro | Auto | Archivos de configuraci√≥n | Escaneo de patrones |\n| 3. Control de Acceso (ACL) | N/A | - | No aplica (tipo de proyecto) |\n| 4. SAST | Auto | SonarQube, OWASP Dependency Check | Configuraci√≥n del proyecto |\n| 5. DAST | Externo | OWASP ZAP - /reports/zap_2025-11-20.html | An√°lisis de reporte externo |\n| 6. SCA | MCP Tool | Trivy filesystem scan | Escaneo automatizado |\n```\n\n### Ejemplo de tabla de criterios:\n| Criterio/Hallazgo                       | Estado   | Recomendaci√≥n                                 |\n|------------------------------------------|----------|-----------------------------------------------|\n| Seguridad en la Configuraci√≥n            | ‚úîÔ∏è       | -                                             |\n| Escaneo de Vulnerabilidades              | ‚ùå       | Implementar escaneo autom√°tico                |\n| Gesti√≥n de Secretos                      | ‚ö†Ô∏è       | Revisar uso de variables de entorno           |\n\n### Ejemplo de barra de cumplimiento:\n‚ñà‚ñì‚ñì‚ñí‚ñë‚ñë 67% (4/6 reglas cumplidas)\n\n### Ejemplo de tabla de hallazgos:\n| Nivel     | Archivo                  | L√≠nea | Descripci√≥n                  | Recomendaci√≥n                | Fuente |\n|-----------|--------------------------|-------|------------------------------|------------------------------|--------|\n| üî¥ Cr√≠tico| application.yaml         | 12    | Secreto en texto plano       | Usar Azure KeyVault          | An√°lisis est√°tico |\n| üü† Alto   | /login endpoint          | -     | Sin rate limiting            | Implementar limitaci√≥n       | OWASP ZAP 2025-11-20 |\n| üü† Alto   | .gitignore               | 45    | Falta exclusi√≥n de .env      | A√±adir a .gitignore          | An√°lisis est√°tico |\n\n### Ejemplo de secci√≥n de hallazgos cr√≠ticos justificados:\n```markdown\n## üü° Hallazgos Cr√≠ticos con Justificaci√≥n Aprobada\n\n> **Nota:** Los siguientes hallazgos fueron clasificados como cr√≠ticos pero cuentan con justificaci√≥n documentada y aprobada. No se computan como incumplimientos en el porcentaje de cumplimiento, pero requieren seguimiento.\n\n### HC-001: Credencial en application.yaml l√≠nea 13\n\n**üìç Ubicaci√≥n:** `infrastructure/src/main/resources/application.yaml:13`\n\n**üîç Hallazgo Original:** Credencial de base de datos en texto plano\n\n**üìã Justificaci√≥n:**\n- **Categor√≠a:** RIESGO ACEPTADO\n- **Explicaci√≥n:** Credencial corresponde a ambiente de desarrollo local. La configuraci√≥n de producci√≥n utiliza Azure KeyVault (verificado en application-prod.yaml). Este archivo no se despliega en ambientes productivos seg√∫n pipeline CI/CD.\n- **Responsable:** Arquitecto de Seguridad - Juan P√©rez\n- **Fecha de revisi√≥n:** 2025-12-20\n- **Referencias:** Pol√≠tica de Seguridad ENV-001, Ticket JIRA SEC-456\n\n**‚ö†Ô∏è Condiciones de la Excepci√≥n:**\n1. Solo v√°lido para ambiente de desarrollo local\n2. Requiere revisi√≥n trimestral\n3. Debe migrarse a KeyVault antes del 2025-12-20\n\n**üîÑ Acciones de Seguimiento:**\n- [ ] Revisi√≥n programada para 2025-12-20\n- [ ] Verificar que application-prod.yaml usa KeyVault\n- [ ] Documentar en wiki del equipo\n\n---\n\n### HC-002: Endpoint sin autenticaci√≥n\n\n**üìç Ubicaci√≥n:** `CreateLoanRouter.java:23`\n\n**üîç Hallazgo Original:** Endpoint POST /loan sin autenticaci√≥n\n\n**üìã Justificaci√≥n:**\n- **Categor√≠a:** MITIGACI√ìN EXISTENTE\n- **Explicaci√≥n:** El endpoint est√° protegido por API Gateway de Azure que implementa autenticaci√≥n OAuth2 antes de llegar al microservicio. La configuraci√≥n del gateway requiere token JWT v√°lido.\n- **Responsable:** L√≠der T√©cnico - Mar√≠a Gonz√°lez\n- **Fecha de revisi√≥n:** N/A (control permanente)\n- **Referencias:** Configuraci√≥n Azure APIM - gateway-config.json, Documento ARQ-202\n\n**‚ö†Ô∏è Condiciones de la Excepci√≥n:**\n1. API Gateway debe mantener regla de autenticaci√≥n activa\n2. Logs de gateway deben monitorearse semanalmente\n3. Considerar agregar autenticaci√≥n redundante a nivel de microservicio\n\n**üîÑ Acciones de Seguimiento:**\n- [ ] Verificar mensualmente configuraci√≥n de APIM\n- [ ] Implementar autenticaci√≥n redundante en Sprint 3 (mejora continua)\n\n---\n\n**üìä Resumen de Excepciones:**\n- Total de hallazgos cr√≠ticos justificados: 2\n- Categor√≠as: RIESGO ACEPTADO (1), MITIGACI√ìN EXISTENTE (1)\n- Requieren seguimiento: 2\n- Pr√≥xima revisi√≥n: 2025-12-20\n```\n\n

## PASO 8. Notificaci√≥n\n\n- Notifica al desarrollador:\n  - La ubicaci√≥n del reporte generado\n  - Los principales hallazgos clasificados por criticidad\n  - **N√∫mero de hallazgos cr√≠ticos justificados (si existen)**\n  - El porcentaje de cumplimiento general\n  - Los tres riesgos m√°s relevantes\n  - **Las fuentes utilizadas** (reportes externos vs. validaci√≥n por conocimiento)\n  - **Recomendaci√≥n:** Si no se utilizaron reportes DAST/SCA externos, sugerir ejecutar herramientas espec√≠ficas para un an√°lisis m√°s completo\n  - **Recordatorio:** Si hay hallazgos justificados, recordar las fechas de revisi√≥n programadas\n\n## Instrucciones Generales\n\n- **CR√çTICO:** No omitas el Paso 4. Es OBLIGATORIO preguntar al usuario sobre reportes externos ANTES de evaluar.\n- **CR√çTICO:** No omitas el Paso 6. Si hay hallazgos cr√≠ticos, es OBLIGATORIO preguntar sobre justificaciones.\n- No omitas ning√∫n criterio o regla del recurso 'devsecops-all-rules.md' obtenido.\n- Ejecuta las tools o herramientas en el paso correspondiente a cada regla seg√∫n lo especificado en 'devsecops-all-rules.md'.\n- Si alg√∫n criterio no aplica al tipo de proyecto, ind√≠calo como 'N/A' con justificaci√≥n.\n- El reporte debe ser claro, visual y accionable para el desarrollador.\n- Permite agregar criterios personalizados si el usuario lo solicita.\n- **Transparencia:** Indica claramente en el reporte qu√© hallazgos provienen de reportes externos vs. validaci√≥n por conocimiento.\n- **Limitaciones:** Si una regla fue evaluada por conocimiento en lugar de herramientas especializadas, documentarlo como limitaci√≥n del an√°lisis.\n- **Trazabilidad de Excepciones:** Todas las justificaciones deben quedar documentadas en el reporte con categor√≠a, responsable y seguimiento.